<?php
/**
 * Product Detail Page - Modern Mobile-First Design
 * ThinQShopping Platform
 */

require_once __DIR__ . '/config/constants.php';
require_once __DIR__ . '/config/database.php';
require_once __DIR__ . '/includes/functions.php';

// Start session
if (session_status() === PHP_SESSION_NONE) {
    session_name(SESSION_NAME);
    session_start();
}

$db = new Database();
$conn = $db->getConnection();

// Helper function to get product images
function getProductImages($product) {
    $images = [];
    if (!empty($product['images'])) {
        $imageData = json_decode($product['images'], true);
        if (!empty($imageData) && is_array($imageData)) {
            foreach ($imageData as $img) {
                $imagePath = str_replace('\\/', '/', $img);
                if (strpos($imagePath, '/') === false && strpos($imagePath, 'assets') === false) {
                    $imagePath = 'assets/images/products/' . $imagePath;
                }
                $images[] = BASE_URL . '/' . $imagePath;
            }
        }
    }
    if (empty($images)) {
        $images[] = BASE_URL . '/assets/images/placeholder-product.jpg';
    }
    return $images;
}

// Get product ID
$productId = isset($_GET['id']) && is_numeric($_GET['id']) ? intval($_GET['id']) : null;

if (!$productId) {
    header('Location: ' . BASE_URL . '/shop.php');
    exit;
}

// Get product details
try {
    $stmt = $conn->prepare("
        SELECT p.*, c.name as category_name, c.id as category_id,
               COALESCE((SELECT AVG(rating) FROM product_reviews WHERE product_id = p.id AND is_approved = 1), 0) as avg_rating,
               COALESCE((SELECT COUNT(*) FROM product_reviews WHERE product_id = p.id AND is_approved = 1), 0) as review_count
        FROM products p 
        LEFT JOIN categories c ON p.category_id = c.id 
        WHERE p.id = ? AND p.is_active = 1
    ");
    $stmt->execute([$productId]);
    $product = $stmt->fetch();
    
    if (!$product) {
        header('Location: ' . BASE_URL . '/shop.php');
        exit;
    }
} catch (Exception $e) {
    error_log("Error fetching product: " . $e->getMessage());
    header('Location: ' . BASE_URL . '/shop.php');
    exit;
}

// Get product images
$productImages = getProductImages($product);

// Get product reviews
$reviews = [];
try {
    $stmt = $conn->prepare("
        SELECT pr.*, u.email as user_email
        FROM product_reviews pr
        LEFT JOIN users u ON pr.user_id = u.id
        WHERE pr.product_id = ? AND pr.is_approved = 1
        ORDER BY pr.created_at DESC
        LIMIT 10
    ");
    $stmt->execute([$productId]);
    $reviews = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Error fetching reviews: " . $e->getMessage());
}

// Get related products (same category)
$relatedProducts = [];
try {
    $stmt = $conn->prepare("
        SELECT p.*, c.name as category_name,
               COALESCE((SELECT AVG(rating) FROM product_reviews WHERE product_id = p.id AND is_approved = 1), 0) as avg_rating,
               CASE WHEN p.compare_price > p.price THEN ROUND(((p.compare_price - p.price) / p.compare_price * 100), 0) ELSE 0 END as discount_percent
        FROM products p 
        LEFT JOIN categories c ON p.category_id = c.id
        WHERE p.category_id = ? AND p.id != ? AND p.is_active = 1
        ORDER BY RAND()
        LIMIT 6
    ");
    $stmt->execute([$product['category_id'], $productId]);
    $relatedProducts = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Error fetching related products: " . $e->getMessage());
}

// Calculate discount percentage
$discountPercent = 0;
if (!empty($product['compare_price']) && $product['compare_price'] > $product['price']) {
    $discountPercent = round((($product['compare_price'] - $product['price']) / $product['compare_price']) * 100);
}

// Page title
$pageTitle = htmlspecialchars($product['name']) . ' - ' . APP_NAME;

// Include header
include __DIR__ . '/includes/header.php';
?>

<style>
/* Product Detail Page - Mobile First */
.product-detail-wrapper {
    background: #f8fafc;
    min-height: 100vh;
}

/* Breadcrumb */
.breadcrumb-nav {
    background: #fff;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.8125rem;
}

.breadcrumb-nav a {
    color: #64748b;
    text-decoration: none;
}

.breadcrumb-nav a:hover {
    color: #0e2945;
}

.breadcrumb-nav span {
    color: #94a3b8;
    margin: 0 0.5rem;
}

/* Product Container */
.product-container {
    max-width: 1400px;
    margin: 0 auto;
}

/* Image Gallery */
.image-gallery-section {
    background: #fff;
    padding: 1rem;
}

.main-image-container {
    position: relative;
    width: 100%;
    padding-top: 100%;
    background: #f8fafc;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.main-image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.discount-badge-large {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: #dc2626;
    color: #fff;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 800;
}

.image-thumbnails {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.thumbnail {
    aspect-ratio: 1/1;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e2e8f0;
    cursor: pointer;
    transition: border-color 0.2s;
}

.thumbnail:hover,
.thumbnail.active {
    border-color: #0e2945;
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Product Info */
.product-info-section {
    background: #fff;
    padding: 1.5rem 1rem;
}

.product-category-link {
    display: inline-block;
    font-size: 0.75rem;
    color: #64748b;
    text-transform: uppercase;
    font-weight: 700;
    text-decoration: none;
    margin-bottom: 0.5rem;
}

.product-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: #0e2945;
    line-height: 1.3;
    margin-bottom: 0.75rem;
}

.rating-section {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.stars-display {
    color: #fbbf24;
    font-size: 1.125rem;
}

.rating-text {
    color: #64748b;
    font-weight: 600;
}

.price-section {
    margin-bottom: 1.5rem;
}

.current-price-large {
    font-size: 1.125rem;
    font-weight: 800;
    color: #0e2945;
    margin-right: 0.5rem;
}

.original-price-large {
    font-size: 0.75rem;
    color: #94a3b8;
    text-decoration: line-through;
    font-weight: 500;
}

.savings-text {
    display: inline-block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: #059669;
    font-weight: 700;
}

.stock-section {
    margin-bottom: 1.5rem;
}

.stock-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 700;
}

.stock-badge.in-stock {
    background: #dcfce7;
    color: #166534;
}

.stock-badge.low-stock {
    background: #fef3c7;
    color: #92400e;
}

.stock-badge.out-of-stock {
    background: #fee2e2;
    color: #991b1b;
}

/* Quantity Selector */
.quantity-section {
    margin-bottom: 1.5rem;
}

.quantity-label {
    font-size: 0.875rem;
    font-weight: 700;
    color: #475569;
    margin-bottom: 0.5rem;
    display: block;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.qty-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #e2e8f0;
    background: #fff;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 700;
    color: #0e2945;
    cursor: pointer;
    transition: all 0.2s;
}

.qty-btn:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

.qty-input {
    width: 45px;
    height: 32px;
    text-align: center;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 700;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.btn-add-to-cart {
    width: 100%;
    padding: 0.5rem 0.75rem !important;
    background: #0e2945;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 0.8125rem !important;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-add-to-cart:hover {
    background: #1a3a5c;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(14, 41, 69, 0.2);
}

.btn-buy-now {
    width: 100%;
    padding: 0.5rem 0.75rem !important;
    background: #fff;
    color: #0e2945;
    border: 2px solid #0e2945;
    border-radius: 8px;
    font-size: 0.8125rem !important;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-buy-now:hover {
    background: #f8fafc;
}

/* Product Description */
.description-section {
    background: #fff;
    padding: 1.5rem 1rem;
    margin-top: 1rem;
}

.section-title {
    font-size: 1.125rem;
    font-weight: 800;
    color: #0e2945;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.description-text {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: #475569;
}

/* Specifications */
.specs-section {
    background: #fff;
    padding: 1.5rem 1rem;
    margin-top: 1rem;
}

.specs-table {
    width: 100%;
}

.spec-row {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.spec-label {
    font-size: 0.875rem;
    font-weight: 700;
    color: #64748b;
}

.spec-value {
    font-size: 0.875rem;
    color: #1e293b;
}

/* Reviews */
.reviews-section {
    background: #fff;
    padding: 1.5rem 1rem;
    margin-top: 1rem;
}

.review-item {
    padding: 1rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.reviewer-name {
    font-size: 0.875rem;
    font-weight: 700;
    color: #1e293b;
}

.review-date {
    font-size: 0.75rem;
    color: #94a3b8;
}

.review-stars {
    color: #fbbf24;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.review-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: #475569;
}

/* Related Products */
.related-section {
    background: #fff;
    padding: 1.5rem 1rem;
    margin-top: 1rem;
}

.related-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-top: 1rem;
}

/* Reuse product card styles */
.product-card-small {
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.product-card-small:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(14, 41, 69, 0.12);
}

.product-card-small .product-image-container {
    position: relative;
    width: 100%;
    padding-top: 100%;
    background: #f8fafc;
}

.product-card-small .product-image-container img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-card-small .product-info {
    padding: 0.75rem;
}

.product-card-small .product-name {
    font-size: 0.75rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-card-small .product-price {
    font-size: 0.875rem;
    font-weight: 800;
    color: #0e2945;
}

/* Responsive */
@media (min-width: 768px) {
    .product-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        padding: 2rem;
    }
    
    .image-gallery-section {
        grid-column: 1;
    }
    
    .product-info-section {
        grid-column: 2;
    }
    
    .description-section,
    .specs-section,
    .reviews-section,
    .related-section {
        grid-column: 1 / -1;
    }
    
    .related-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .action-buttons {
        flex-direction: row;
    }
}

@media (min-width: 1024px) {
    .related-grid {
        grid-template-columns: repeat(6, 1fr);
    }
}
</style>

<div class="product-detail-wrapper">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
        <a href="<?php echo BASE_URL; ?>">Home</a>
        <span>›</span>
        <a href="<?php echo BASE_URL; ?>/shop.php">Shop</a>
        <?php if (!empty($product['category_name'])): ?>
            <span>›</span>
            <a href="<?php echo BASE_URL; ?>/shop.php?category=<?php echo $product['category_id']; ?>">
                <?php echo htmlspecialchars($product['category_name']); ?>
            </a>
        <?php endif; ?>
        <span>›</span>
        <span style="color: #0e2945; font-weight: 600;"><?php echo htmlspecialchars($product['name']); ?></span>
    </nav>

    <div class="product-container">
        <!-- Image Gallery -->
        <div class="image-gallery-section">
            <div class="main-image-container" id="mainImage">
                <img src="<?php echo $productImages[0]; ?>" alt="<?php echo htmlspecialchars($product['name']); ?>" id="mainImageEl">
                <?php if ($discountPercent > 0): ?>
                    <div class="discount-badge-large">-<?php echo $discountPercent; ?>%</div>
                <?php endif; ?>
            </div>
            
            <?php if (count($productImages) > 1): ?>
            <div class="image-thumbnails">
                <?php foreach ($productImages as $index => $image): ?>
                    <div class="thumbnail <?php echo $index === 0 ? 'active' : ''; ?>" 
                         onclick="changeImage('<?php echo $image; ?>', this)">
                        <img src="<?php echo $image; ?>" alt="Thumbnail <?php echo $index + 1; ?>">
                    </div>
                <?php endforeach; ?>
            </div>
            <?php endif; ?>
        </div>

        <!-- Product Info -->
        <div class="product-info-section">
            <?php if (!empty($product['category_name'])): ?>
                <a href="<?php echo BASE_URL; ?>/shop.php?category=<?php echo $product['category_id']; ?>" 
                   class="product-category-link">
                    <?php echo htmlspecialchars($product['category_name']); ?>
                </a>
            <?php endif; ?>
            
            <h1 class="product-title"><?php echo htmlspecialchars($product['name']); ?></h1>
            
            <?php if ($product['review_count'] > 0): ?>
            <div class="rating-section">
                <span class="stars-display">★★★★★</span>
                <span class="rating-text">
                    <?php echo number_format($product['avg_rating'], 1); ?> 
                    (<?php echo $product['review_count']; ?> <?php echo $product['review_count'] == 1 ? 'review' : 'reviews'; ?>)
                </span>
            </div>
            <?php endif; ?>
            
            <div class="price-section">
                <span class="current-price-large"><?php echo formatCurrency($product['price']); ?></span>
                <?php if (!empty($product['compare_price']) && $product['compare_price'] > $product['price']): ?>
                    <span class="original-price-large"><?php echo formatCurrency($product['compare_price']); ?></span>
                    <div class="savings-text">
                        You save <?php echo formatCurrency($product['compare_price'] - $product['price']); ?> 
                        (<?php echo $discountPercent; ?>%)
                    </div>
                <?php endif; ?>
            </div>
            
            <div class="stock-section">
                <?php if ($product['stock_quantity'] > 10): ?>
                    <span class="stock-badge in-stock">
                        <i class="fas fa-check-circle"></i> In Stock
                    </span>
                <?php elseif ($product['stock_quantity'] > 0): ?>
                    <span class="stock-badge low-stock">
                        <i class="fas fa-exclamation-triangle"></i> Only <?php echo $product['stock_quantity']; ?> left!
                    </span>
                <?php else: ?>
                    <span class="stock-badge out-of-stock">
                        <i class="fas fa-times-circle"></i> Out of Stock
                    </span>
                <?php endif; ?>
            </div>
            
            <?php if ($product['stock_quantity'] > 0): ?>
            <div class="quantity-section">
                <label class="quantity-label">Quantity</label>
                <div class="quantity-controls">
                    <button class="qty-btn" onclick="decreaseQty()">−</button>
                    <input type="number" id="quantity" class="qty-input" value="1" min="1" max="<?php echo $product['stock_quantity']; ?>">
                    <button class="qty-btn" onclick="increaseQty()">+</button>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn-add-to-cart" onclick="addToCart(<?php echo $product['id']; ?>)">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
                <button class="btn-buy-now" onclick="buyNow(<?php echo $product['id']; ?>)">
                    Buy Now
                </button>
            </div>
            <?php endif; ?>
        </div>

        <!-- Description -->
        <?php if (!empty($product['description'])): ?>
        <div class="description-section">
            <h2 class="section-title">Product Description</h2>
            <div class="description-text">
                <?php echo nl2br(htmlspecialchars($product['description'])); ?>
            </div>
        </div>
        <?php endif; ?>

        <!-- Specifications -->
        <div class="specs-section">
            <h2 class="section-title">Specifications</h2>
            <div class="specs-table">
                <?php if (!empty($product['sku'])): ?>
                <div class="spec-row">
                    <div class="spec-label">SKU</div>
                    <div class="spec-value"><?php echo htmlspecialchars($product['sku']); ?></div>
                </div>
                <?php endif; ?>
                <div class="spec-row">
                    <div class="spec-label">Category</div>
                    <div class="spec-value"><?php echo htmlspecialchars($product['category_name'] ?? 'Uncategorized'); ?></div>
                </div>
                <div class="spec-row">
                    <div class="spec-label">Availability</div>
                    <div class="spec-value">
                        <?php echo $product['stock_quantity'] > 0 ? 'In Stock (' . $product['stock_quantity'] . ' units)' : 'Out of Stock'; ?>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews -->
        <?php if (!empty($reviews)): ?>
        <div class="reviews-section">
            <h2 class="section-title">Customer Reviews</h2>
            <?php foreach ($reviews as $review): ?>
                <div class="review-item">
                    <div class="review-header">
                        <span class="reviewer-name"><?php echo htmlspecialchars(substr($review['user_email'], 0, strpos($review['user_email'], '@'))); ?></span>
                        <span class="review-date"><?php echo date('M d, Y', strtotime($review['created_at'])); ?></span>
                    </div>
                    <div class="review-stars">
                        <?php echo str_repeat('★', $review['rating']) . str_repeat('☆', 5 - $review['rating']); ?>
                    </div>
                    <?php if (!empty($review['comment'])): ?>
                        <div class="review-text"><?php echo nl2br(htmlspecialchars($review['comment'])); ?></div>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>
        <?php endif; ?>

        <!-- Related Products -->
        <?php if (!empty($relatedProducts)): ?>
        <div class="related-section">
            <h2 class="section-title">You May Also Like</h2>
            <div class="related-grid">
                <?php foreach ($relatedProducts as $related): ?>
                    <a href="<?php echo BASE_URL; ?>/product-detail.php?id=<?php echo $related['id']; ?>" class="product-card-small">
                        <div class="product-image-container">
                            <?php
                            $relatedImages = getProductImages($related);
                            ?>
                            <img src="<?php echo $relatedImages[0]; ?>" alt="<?php echo htmlspecialchars($related['name']); ?>">
                        </div>
                        <div class="product-info">
                            <div class="product-name"><?php echo htmlspecialchars($related['name']); ?></div>
                            <div class="product-price"><?php echo formatCurrency($related['price']); ?></div>
                        </div>
                    </a>
                <?php endforeach; ?>
            </div>
        </div>
        <?php endif; ?>
    </div>
</div>

<script>
// Image gallery
function changeImage(imageSrc, element) {
    document.getElementById('mainImageEl').src = imageSrc;
    document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
    element.classList.add('active');
}

// Quantity controls
function increaseQty() {
    const input = document.getElementById('quantity');
    const max = parseInt(input.max);
    const current = parseInt(input.value);
    if (current < max) {
        input.value = current + 1;
    }
}

function decreaseQty() {
    const input = document.getElementById('quantity');
    const current = parseInt(input.value);
    if (current > 1) {
        input.value = current - 1;
    }
}

// Add to cart
function addToCart(productId) {
    const quantity = document.getElementById('quantity').value;
    
    // Send to cart API
    fetch('<?php echo BASE_URL; ?>/api/cart/add.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: parseInt(quantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Product added to cart!');
            // Update cart count in header if exists
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
                cartCount.textContent = data.cart_count || '';
            }
        } else {
            alert(data.message || 'Error adding to cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding to cart. Please try again.');
    });
}

// Buy now
function buyNow(productId) {
    const quantity = document.getElementById('quantity').value;
    
    // Add to cart then redirect to checkout
    fetch('<?php echo BASE_URL; ?>/api/cart/add.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: parseInt(quantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '<?php echo BASE_URL; ?>/checkout.php';
        } else {
            alert(data.message || 'Error processing request');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing request. Please try again.');
    });
}
</script>

<?php
// Include footer
include __DIR__ . '/includes/footer.php';
?>
